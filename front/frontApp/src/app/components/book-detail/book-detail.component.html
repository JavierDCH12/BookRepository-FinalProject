<div class="book-detail-container" *ngIf="!isLoading && book; else loading">
  <div class="book-header">
    <img *ngIf="book.cover_url" title="cover" [src]="book.cover_url" [alt]="'Portada del libro ' + book.title" class="book-cover">
    <div class="book-info">
      <h1>{{ book.title }}</h1>
      <p><strong>Autor:</strong> {{ book.author }}</p>
      <p *ngIf="book.first_publish_year"><strong>Publicado en:</strong> {{ book.first_publish_year }}</p>

      <p *ngIf="book.genres && book.genres.length > 0">
        <strong>GÃ©neros:</strong> {{ formatGenres(book.genres) }}
      </p>

      <p *ngIf="book.isbn"><strong>ISBN:</strong> {{ book.isbn }}</p>
    </div>
  </div>

  <div class="description-section">
    <h3>DescripciÃ³n</h3>
    <p class="description">{{ book.description || 'No hay descripciÃ³n disponible.' }}</p>
  </div>

  <div class="actions">
    <button (click)="isFavorite ? removeFromFavorites() : addToFavorites()">
      {{ isFavorite ? 'âŒ Quitar de Favoritos' : 'â­ AÃ±adir a Favoritos' }}
    </button>
  </div>

  <div *ngIf="isFavorite" class="review-section">
    <h3>Tu reseÃ±a y valoraciÃ³n</h3>

    <div *ngIf="!isEditingReview">
      <blockquote *ngIf="reviewText; else noReview">{{ reviewText }}</blockquote>
      <ng-template #noReview>
        <p class="review-placeholder">AÃºn no has escrito una reseÃ±a. Haz clic abajo para escribir una.</p>
      </ng-template>
      <button (click)="startEditReview()">âœï¸ Escribir o editar reseÃ±a</button>
    </div>

    <div *ngIf="isEditingReview" class="edit-review-form">
      <textarea [(ngModel)]="reviewText" placeholder="Escribe tu reseÃ±a aquÃ­..."></textarea>
      <div class="review-actions">
        <button [disabled]="!reviewText.trim()" (click)="saveReview()">ğŸ’¾ Guardar</button>
        <button (click)="cancelEditReview()">âŒ Cancelar</button>
      </div>
    </div>

    <div class="rating-section">
      <h4>â­ Tu valoraciÃ³n</h4>
      <div class="stars">
        <span *ngFor="let star of [1,2,3,4,5]"
              (click)="setRating(star)"
              (mouseenter)="onStarHover(star)"
              (mouseleave)="onStarLeave()"
              [title]="star + ' estrella' + (star > 1 ? 's' : '')"
              [ngClass]="{ 'filled-star': star <= (tempRating || rating), 'empty-star': star > (tempRating || rating) }">
          â˜…
        </span>
      </div>
    </div>
  </div>

  <!-- ğŸ’¬ Opiniones pÃºblicas -->
  <div class="public-reviews" *ngIf="publicReviews.length > 0">
    <h3>ğŸ’¬ Opiniones de otros lectores</h3>

    <div class="review-card" *ngFor="let review of publicReviews">
      <div class="review-header">
        <img
          class="avatar"
          [src]="review.profile_picture || 'https://rorwpelcykogxwqyaopv.supabase.co/storage/v1/object/public/profile-pictures//default_avatar.jpg'"
          [alt]="'Foto de ' + review.username"
          [title]="review.username"
          (click)="navigateToPublicProfile(review.username)"
          alt="Avatar de usuario"
        />
        <div class="review-user">
          <strong 
            class="clickable-username" 
            (click)="navigateToPublicProfile(review.username)">
            {{ review.username }}
          </strong>
          <span class="review-rating">
            <ng-container *ngFor="let star of [1,2,3,4,5]">
              <span [ngClass]="{ 'filled-star': star <= review.rating, 'empty-star': star > review.rating }">â˜…</span>
            </ng-container>
          </span>
        </div>
      </div>
      <blockquote class="review-text">â€œ{{ review.review }}â€</blockquote>
    </div>
  </div>

  <!-- ğŸ’¡ Si no hay reseÃ±as -->
  <div class="public-reviews" *ngIf="publicReviews.length === 0">
    <h4>ğŸ“­ AÃºn no hay reseÃ±as pÃºblicas de este libro.</h4>
    <p>Â¡SÃ© el primero en compartir tu opiniÃ³n al aÃ±adirlo a favoritos!</p>
  </div>

  <div class="go-home">
    <button type="button" (click)="navigateToHome()">ğŸ  Volver al inicio</button>
  </div>
</div>

<ng-template #loading>
  <p class="loading-text">â³ Cargando detalles del libro...</p>
</ng-template>
